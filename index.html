<!doctype html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>DataLayer sync</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">

    <!-- Google Tag Manager -->
    <script>(function (w, d, s, l, i) {
        w[l] = w[l] || [];
        w[l].push({
            'gtm.start':
                new Date().getTime(), event: 'gtm.js'
        });
        var f = d.getElementsByTagName(s)[0],
            j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : '';
        j.async = true;
        j.src =
            'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
        f.parentNode.insertBefore(j, f);
    })(window, document, 'script', 'dataLayer', 'GTM-XXXXXXXX');</script>
    <!-- End Google Tag Manager -->


    <!-- Matomo Tag Manager -->
    <script>
        var _mtm = window._mtm = window._mtm || [];
        _mtm.push({'mtm.startTime': (new Date().getTime()), 'event': 'mtm.Start'});
        var d = document, g = d.createElement('script'), s = d.getElementsByTagName('script')[0];
        g.async = true;
        g.src = 'https://matomo.website.com/js/container_XXXXXXX.js';
        s.parentNode.insertBefore(g, s);
    </script>
    <!-- End Matomo Tag Manager -->
</head>
<body>

<section class="py-5">
    <div class="container">
        <h1>Demo DataLayer</h1>
        <br>
        <button class="btn btn-primary" onclick="seedDataLayer()">Click me</button>
    </div>
</section>

<script>

    /**** COPY FROM HERE ****/

    let syncDataLayer = function(array, callback) {
        array.push = function(e) {
            Array.prototype.push.call(array, e);
            callback(array);
        };
    };

    syncDataLayer(window.dataLayer, function(e) {
        window._mtm.push(dataLayer.at(-1))
    });

    /**** TO HERE ****/

    function seedDataLayer() {
        dataLayer.push({
            'event': 'demo',
            'data': {
                'first': 1,
                'second': 2
            }
        })
    }
</script>

</body>
</html>